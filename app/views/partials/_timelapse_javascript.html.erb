<script>
	$(function(){
		var TIMELAPSE_IMAGES_HASH;
		var TOTAL_IMAGES_IN_CURRENT_HUB;
		//single integer value 0..n generated by iterating through hubs.each_with_index
		var CURRENT_TIMELAPSE_IMAGE_NUMBER = 0;
		var TIMELAPSE_INTERVAL;
		var CURRENT_HUB_ID = -1;
		var PREVIOUS_HUB_ID = -1;
		
		function nextImage(){
			var $imageToRemove = $(TIMELAPSE_IMAGES_HASH[CURRENT_TIMELAPSE_IMAGE_NUMBER]);
			$imageToRemove.addClass('display-none').removeClass('active');

			if(typeof TIMELAPSE_IMAGES_HASH[CURRENT_TIMELAPSE_IMAGE_NUMBER + 1] === "undefined"){
				CURRENT_TIMELAPSE_IMAGE_NUMBER = 0;
				$(TIMELAPSE_IMAGES_HASH[0]).removeClass('display-none').addClass('active');
			} else {
				$(TIMELAPSE_IMAGES_HASH[CURRENT_TIMELAPSE_IMAGE_NUMBER + 1]).removeClass('display-none').addClass('active');
				CURRENT_TIMELAPSE_IMAGE_NUMBER = CURRENT_TIMELAPSE_IMAGE_NUMBER + 1;
			}
			addOrUpdatePictureSequenceDisplay();
		};
		
		function addOrUpdatePictureSequenceDisplay(){
			var totalImages = (typeof TOTAL_IMAGES_IN_CURRENT_HUB === "undefined") ? "..." : TOTAL_IMAGES_IN_CURRENT_HUB;
			$("#picSequenceDisplay").html("Picture " + (CURRENT_TIMELAPSE_IMAGE_NUMBER+1) + " of " + totalImages);
		}
		function startTimelapse(){
			var intervalTime = parseInt($('#intervalTime').val());
			//resume timelapse with current image if unhovering returns to same timelapse
			if(CURRENT_HUB_ID !== PREVIOUS_HUB_ID){
				CURRENT_TIMELAPSE_IMAGE_NUMBER = 0;
			}

			TIMELAPSE_INTERVAL = setInterval(function(){
				nextImage();
			}, intervalTime)
		};
		
		function convertImagesToHash(images, callback){
			var hash = {};
			TOTAL_IMAGES_IN_CURRENT_HUB = images.length;
			for(var i = 0; i < images.length; i++){
				hash[$(images[i]).data("order-id")] = images[i];
			}
			callback();
			return hash;
		};
		
		$(".timelapse-display").hover(
			function(e){
			e.preventDefault();
			CURRENT_HUB_ID = $(e.currentTarget).data("hub-id");
			var images = $(e.currentTarget).find(".timelapse-image");
			TIMELAPSE_IMAGES_HASH = convertImagesToHash(images, startTimelapse);
		}, function(e){
			e.preventDefault();
			clearInterval(TIMELAPSE_INTERVAL);
			PREVIOUS_HUB_ID = CURRENT_HUB_ID;
		});
		
		addOrUpdatePictureSequenceDisplay();
	});
</script>